name: QuizBot - Auto Generate & Upload

on:
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of videos to generate'
        required: false
        default: '1'
      test_only:
        description: 'Test mode - generate but DO NOT upload (saves quota)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_delay:
        description: 'Skip random delay (for testing)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
  
  # Scheduled runs - MAXIMIZED (6 times per day)
  schedule:
    - cron: '0 4 * * *'   # 4 AM UTC
    - cron: '0 8 * * *'   # 8 AM UTC
    - cron: '0 12 * * *'  # 12 PM UTC
    - cron: '0 16 * * *'  # 4 PM UTC
    - cron: '0 20 * * *'  # 8 PM UTC
    - cron: '0 0 * * *'   # 12 AM UTC

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Random delay for stealth (0-45 min)
        if: github.event.inputs.skip_delay != 'true'
        run: |
          DELAY=$((RANDOM % 2700))
          echo "â±ï¸ Waiting $DELAY seconds ($(($DELAY / 60)) minutes) for randomization..."
          sleep $DELAY
          echo "âœ… Starting execution at $(date -u)"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download background video
        run: |
          mkdir -p assets/backgrounds
          curl -L -o assets/backgrounds/abstract_bg.mp4 \
            "https://videos.pexels.com/video-files/3129671/3129671-uhd_2560_1440_30fps.mp4" || \
          curl -L -o assets/backgrounds/abstract_bg.mp4 \
            "https://videos.pexels.com/video-files/856973/856973-hd_1920_1080_30fps.mp4" || true

      - name: Generate AI questions (MAXIMIZED - 200 questions)
        run: |
          echo "ðŸ¤– Generating maximum AI content..."
          python ai_generator.py 200
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Generate and Upload Videos
        run: |
          BATCH_SIZE="${{ github.event.inputs.batch_size || '3' }}"
          TEST_ONLY="${{ github.event.inputs.test_only || 'false' }}"
          
          if [ "$TEST_ONLY" = "true" ]; then
            echo "ðŸ§ª TEST MODE - Generating $BATCH_SIZE videos WITHOUT upload..."
            python script.py --batch $BATCH_SIZE --no-upload
          else
            echo "ðŸŽ¬ Generating $BATCH_SIZE videos WITH upload..."
            python script.py --batch $BATCH_SIZE --upload
          fi
        env:
          AUTO_UPLOAD: ${{ github.event.inputs.test_only != 'true' }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          PYTHONUNBUFFERED: "1"

      - name: Save videos as artifacts (for preview)
        if: github.event.inputs.test_only == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-videos
          path: output/*.mp4
          retention-days: 7
        continue-on-error: true

      - name: Log run to dashboard
        run: |
          echo "{\"project\": \"QuizBot\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"videos\": 3, \"status\": \"success\"}" >> run_log.json
        continue-on-error: true

      - name: Summary
        run: |
          echo "## ðŸŽ¬ QuizBot Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Videos Generated:** 3" >> $GITHUB_STEP_SUMMARY
          echo "**Uploaded to YouTube:** âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“º **Channel:** https://www.youtube.com/channel/UC4Y6O0ubwl0_ZQsLq2EteTQ" >> $GITHUB_STEP_SUMMARY

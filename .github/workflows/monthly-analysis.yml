name: Monthly Viral Analysis - Learn from Top AI Shorts

# Runs once a month to analyze successful AI-generated Shorts channels
# and feed learnings back into our video generation system

on:
  # Monthly on the 1st at 3 AM UTC
  schedule:
    - cron: '0 3 1 * *'
  
  # Manual trigger for testing
  workflow_dispatch:

jobs:
  analyze-viral-channels:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-api-python-client

      - name: Restore persistent state
        uses: dawidd6/action-download-artifact@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          name: persistent-state
          path: data/persistent/
          if_no_artifact_found: ignore
          search_artifacts: true
        continue-on-error: true

      - name: Create data directories
        run: mkdir -p data/persistent data/analysis

      # ================================================================
      # MAIN ANALYSIS: Find and learn from top AI-generated Shorts
      # ================================================================
      - name: Analyze Top AI Shorts Channels
        id: analysis
        run: python monthly_analysis.py
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

      # Save updated patterns for video generator to use
      - name: Save updated patterns
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: persistent-state
          path: data/persistent/
          retention-days: 30
          overwrite: true

      - name: Summary
        run: |
          echo "## Monthly Viral Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What This Does" >> $GITHUB_STEP_SUMMARY
          echo "1. Searches YouTube for top-performing AI-generated Shorts" >> $GITHUB_STEP_SUMMARY
          echo "2. Analyzes title patterns, hooks, engagement tactics" >> $GITHUB_STEP_SUMMARY
          echo "3. Uses AI to extract reusable patterns" >> $GITHUB_STEP_SUMMARY
          echo "4. Saves patterns to persistent state" >> $GITHUB_STEP_SUMMARY
          echo "5. Video generator uses these patterns automatically!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quota Used" >> $GITHUB_STEP_SUMMARY
          echo "- YouTube API: ~30-50 read operations (very cheap)" >> $GITHUB_STEP_SUMMARY
          echo "- Groq: ~1000 tokens for analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The next video generation will automatically use the new patterns!" >> $GITHUB_STEP_SUMMARY

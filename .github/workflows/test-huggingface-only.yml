name: TEST - HuggingFace Only Video Generation

# This workflow tests video generation using ONLY HuggingFace as the AI provider
# - No Gemini, Groq, or OpenRouter (those keys are not provided)
# - No regeneration attempts (max_regen=0)
# - Full enhancement verification
# - Detailed logging for debugging

on:
  workflow_dispatch:
    inputs:
      category:
        description: 'Video category (leave empty for AI to decide)'
        required: false
        default: ''
        type: string

jobs:
  test-huggingface-only:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Install system dependencies for video processing
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick fonts-dejavu-core fonts-liberation
          
          # Fix ImageMagick policy for video generation
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml || true
          sudo sed -i 's/<policy domain="path" rights="none" pattern="@\*"/<policy domain="path" rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml || true
      
      - name: Create directories
        run: |
          mkdir -p assets/backgrounds assets/broll assets/music assets/sfx assets/fonts
          mkdir -p output cache data/persistent test_output
      
      - name: Restore Persistent State
        run: |
          ARTIFACT_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?name=persistent-state&per_page=1" \
            | jq -r '.artifacts[0].id')
          
          if [ "$ARTIFACT_ID" != "null" ] && [ -n "$ARTIFACT_ID" ]; then
            curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
              -o /tmp/state.zip
            unzip -o /tmp/state.zip -d data/persistent/ 2>/dev/null || true
            echo "[OK] Restored patterns from artifact $ARTIFACT_ID"
          else
            echo "[INFO] No previous state found - starting fresh"
          fi
        continue-on-error: true

      - name: Pre-fetch B-roll
        run: python fetch_broll.py || true
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        continue-on-error: true

      - name: Generate Video with HuggingFace ONLY
        env:
          # ONLY HuggingFace key - forces HuggingFace as primary provider
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          # Explicitly NOT providing: GEMINI_API_KEY, GROQ_API_KEY, OPENROUTER_API_KEY
          PYTHONUNBUFFERED: "1"
          # Disable regeneration
          MAX_REGEN_ATTEMPTS: "0"
        run: |
          echo "=============================================="
          echo "  HUGGINGFACE-ONLY VIDEO GENERATION TEST"
          echo "=============================================="
          echo "Provider: HuggingFace Inference API ONLY"
          echo "Regeneration: DISABLED (max_regen=0)"
          echo "Category: ${{ github.event.inputs.category || 'AI decides' }}"
          echo "=============================================="
          echo ""
          
          # Create a wrapper script that forces HuggingFace and no regen
          python << 'PYTHON_SCRIPT'
import os
import sys
import json
from datetime import datetime

# Add src to path
sys.path.insert(0, 'src')
sys.path.insert(0, 'src/core')
sys.path.insert(0, 'src/quota')

print("=" * 60)
print("  HUGGINGFACE-ONLY TEST - ENHANCEMENT VERIFICATION")
print("=" * 60)
print()

# Track enhancements
enhancements_checked = []

# Import the video generator
from pro_video_generator import ProVideoGenerator, safe_print

# Override environment to force HuggingFace
os.environ['GEMINI_API_KEY'] = ''  # Clear Gemini
os.environ['GROQ_API_KEY'] = ''    # Clear Groq
os.environ['OPENROUTER_API_KEY'] = ''  # Clear OpenRouter

# Initialize generator
print("[1/8] Initializing Video Generator...")
generator = ProVideoGenerator()

# Force HuggingFace as primary
generator.gemini_key = None
generator.groq_key = None
generator.openrouter_key = None
generator.gemini_model = None
generator.client = None
generator.openrouter_available = False

# Verify HuggingFace is available
print(f"[+] HuggingFace available: {generator.huggingface_available}")
print(f"[+] HuggingFace key: {'SET' if generator.huggingface_key else 'NOT SET'}")

if not generator.huggingface_available:
    print("[!] ERROR: HuggingFace key not available!")
    sys.exit(1)

print()
print("[2/8] Testing HuggingFace Model Discovery...")
try:
    from quota.quota_optimizer import get_quota_optimizer
    quota_opt = get_quota_optimizer()
    hf_models = quota_opt.get_huggingface_models(generator.huggingface_key, force_refresh=True)
    print(f"[+] Found {len(hf_models)} HuggingFace models:")
    for m in hf_models[:5]:
        print(f"    - {m}")
    enhancements_checked.append(("HuggingFace Dynamic Discovery", "PASS", f"{len(hf_models)} models found"))
except Exception as e:
    print(f"[!] Model discovery error: {e}")
    enhancements_checked.append(("HuggingFace Dynamic Discovery", "FAIL", str(e)))

print()
print("[3/8] Testing AI Call with HuggingFace...")
try:
    test_prompt = "Generate a single catchy topic for a viral YouTube Short about psychology. Just the topic, nothing else."
    result = generator.call_ai(test_prompt)
    if result:
        print(f"[+] AI Response: {result[:100]}...")
        enhancements_checked.append(("HuggingFace AI Call", "PASS", result[:50]))
    else:
        print("[!] AI call returned empty")
        enhancements_checked.append(("HuggingFace AI Call", "FAIL", "Empty response"))
except Exception as e:
    print(f"[!] AI call error: {e}")
    enhancements_checked.append(("HuggingFace AI Call", "FAIL", str(e)))

print()
print("[4/8] Generating Video (NO REGENERATION)...")
print("-" * 60)

# Override max_regen to 0
import types
original_generate = generator.generate_video

def generate_no_regen(*args, **kwargs):
    """Wrapper to disable regeneration"""
    kwargs['max_regen'] = 0
    return original_generate(*args, **kwargs)

generator.generate_video = types.MethodType(lambda self, *a, **kw: generate_no_regen(*a, **kw), generator)

# Generate the video
try:
    category = os.environ.get('INPUT_CATEGORY', '') or None
    result = generator.generate_video(category=category, upload=False, max_regen=0)
    
    if result:
        print()
        print("=" * 60)
        print("  VIDEO GENERATED SUCCESSFULLY!")
        print("=" * 60)
        print(f"  Title: {result.get('title', 'N/A')}")
        print(f"  Category: {result.get('category', 'N/A')}")
        print(f"  Quality Score: {result.get('quality_score', 'N/A')}/10")
        print(f"  Duration: {result.get('duration', 'N/A')}s")
        print(f"  Video File: {result.get('video_path', 'N/A')}")
        
        enhancements_checked.append(("Video Generation", "PASS", f"Score: {result.get('quality_score', 'N/A')}/10"))
        
        # Check enhancement integration
        print()
        print("[5/8] Verifying Enhancement Integration...")
        
        # Check v9 enhancements
        if hasattr(generator, 'enhancement_orch') and generator.enhancement_orch:
            print("[+] Enhancement Orchestrator: ACTIVE")
            enhancements_checked.append(("Enhancement Orchestrator", "PASS", "Active"))
        else:
            print("[!] Enhancement Orchestrator: NOT FOUND")
            enhancements_checked.append(("Enhancement Orchestrator", "FAIL", "Not initialized"))
        
        # Check learning engine
        if hasattr(generator, 'learning_engine') and generator.learning_engine:
            print("[+] Self-Learning Engine: ACTIVE")
            enhancements_checked.append(("Self-Learning Engine", "PASS", "Active"))
        else:
            print("[!] Self-Learning Engine: NOT FOUND")
            enhancements_checked.append(("Self-Learning Engine", "FAIL", "Not initialized"))
        
        # Check v12 enhancements
        if hasattr(generator, 'v12_enhancements') and generator.v12_enhancements:
            print("[+] V12 Enhancements: ACTIVE")
            enhancements_checked.append(("V12 Enhancements", "PASS", "Active"))
        else:
            print("[!] V12 Enhancements: NOT FOUND")
            enhancements_checked.append(("V12 Enhancements", "FAIL", "Not initialized"))
        
        # Check variety state
        variety_file = 'data/persistent/variety_state.json'
        if os.path.exists(variety_file):
            with open(variety_file) as f:
                variety = json.load(f)
            print(f"[+] Variety State: {len(variety)} keys loaded")
            enhancements_checked.append(("Variety State", "PASS", f"{len(variety)} keys"))
        else:
            print("[!] Variety State: NOT FOUND")
            enhancements_checked.append(("Variety State", "INFO", "No previous state"))
        
        # Check viral patterns
        patterns_file = 'data/persistent/viral_patterns.json'
        if os.path.exists(patterns_file):
            with open(patterns_file) as f:
                patterns = json.load(f)
            print(f"[+] Viral Patterns: {len(patterns)} keys loaded")
            enhancements_checked.append(("Viral Patterns", "PASS", f"{len(patterns)} keys"))
        else:
            print("[!] Viral Patterns: NOT FOUND")
            enhancements_checked.append(("Viral Patterns", "INFO", "No previous patterns"))
        
        print()
        print("[6/8] Saving Video Metadata...")
        
        # Save detailed metadata
        metadata = {
            "test_type": "huggingface_only",
            "timestamp": datetime.now().isoformat(),
            "provider_used": "HuggingFace",
            "result": result,
            "enhancements_checked": enhancements_checked,
            "quality_score": result.get('quality_score'),
            "regeneration_attempts": 0,
            "success": True
        }
        
        with open('test_output/video_metadata.json', 'w') as f:
            json.dump(metadata, f, indent=2, default=str)
        
        # Copy video to test_output
        import shutil
        video_path = result.get('video_path')
        if video_path and os.path.exists(video_path):
            shutil.copy(video_path, 'test_output/')
            print(f"[+] Video copied to test_output/")
        
    else:
        print("[!] Video generation returned None")
        enhancements_checked.append(("Video Generation", "FAIL", "Returned None"))
        
except Exception as e:
    import traceback
    print(f"[!] Video generation error: {e}")
    traceback.print_exc()
    enhancements_checked.append(("Video Generation", "FAIL", str(e)))

print()
print("[7/8] Enhancement Check Summary...")
print("-" * 60)
print(f"{'Enhancement':<35} {'Status':<8} {'Details'}")
print("-" * 60)
for name, status, details in enhancements_checked:
    status_icon = "âœ“" if status == "PASS" else "âœ—" if status == "FAIL" else "â„¹"
    print(f"{name:<35} {status_icon} {status:<6} {details[:30]}")
print("-" * 60)

passed = sum(1 for _, s, _ in enhancements_checked if s == "PASS")
failed = sum(1 for _, s, _ in enhancements_checked if s == "FAIL")
print(f"Total: {passed} passed, {failed} failed")

print()
print("[8/8] Test Complete!")
print("=" * 60)

# Save enhancement report
with open('test_output/enhancement_report.json', 'w') as f:
    json.dump({
        "enhancements_checked": enhancements_checked,
        "passed": passed,
        "failed": failed,
        "timestamp": datetime.now().isoformat()
    }, f, indent=2)

sys.exit(0 if failed == 0 else 1)
PYTHON_SCRIPT

      - name: Upload Generated Video
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: huggingface-test-video-${{ github.run_number }}
          path: |
            test_output/*.mp4
            output/*.mp4
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Upload Video Metadata & Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: huggingface-test-metadata-${{ github.run_number }}
          path: |
            test_output/*.json
            test_output/*.txt
            data/persistent/*.json
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Save Persistent State
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: persistent-state
          path: data/persistent/
          retention-days: 30
          if-no-files-found: ignore
          overwrite: true
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤— HuggingFace-Only Test Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Provider:** HuggingFace Inference API ONLY" >> $GITHUB_STEP_SUMMARY
          echo "- **Regeneration:** Disabled (0 attempts)" >> $GITHUB_STEP_SUMMARY
          echo "- **Purpose:** Test enhancements with fresh API quota" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Results" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Actions** â†’ **This workflow run**" >> $GITHUB_STEP_SUMMARY
          echo "2. Scroll down to **Artifacts**" >> $GITHUB_STEP_SUMMARY
          echo "3. Download **huggingface-test-video-${{ github.run_number }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f test_output/video_metadata.json ]; then
            echo "### Video Metadata" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat test_output/video_metadata.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f test_output/enhancement_report.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Enhancement Report" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat test_output/enhancement_report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files Generated" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la test_output/ 2>/dev/null || echo "No files in test_output"
          ls -la output/*.mp4 2>/dev/null || echo "No videos in output"
          echo '```' >> $GITHUB_STEP_SUMMARY


name: Aggressive Mode - Extra Analytics

# Use surplus quota for extra analytics, learning, and research
# Runs every 6 hours when enabled via AGGRESSIVE_MODE env var
#
# QUOTA USAGE:
# - Production quota ALWAYS reserved first (~550 calls/day)
# - Surplus quota (~17,000 calls/day) used for extra features

on:
  schedule:
    - cron: '30 */6 * * *'  # Every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  AGGRESSIVE_MODE: "1"  # Enable aggressive mode

jobs:
  aggressive-mode:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Restore Persistent State
        run: |
          mkdir -p data/persistent
          
          ARTIFACT_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?name=persistent-state&per_page=1" \
            | jq -r '.artifacts[0].id')
          
          if [ "$ARTIFACT_ID" != "null" ] && [ -n "$ARTIFACT_ID" ]; then
            curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
              -o /tmp/state.zip
            unzip -o /tmp/state.zip -d data/persistent/ 2>/dev/null || true
            echo "[OK] Restored persistent state"
          fi
      
      - name: Run Aggressive Mode Actions
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          echo "=============================================="
          echo "  AGGRESSIVE MODE: USING SURPLUS QUOTA"
          echo "=============================================="
          
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          from src.core.aggressive_mode import (
              is_aggressive_mode_enabled,
              get_aggressive_mode_summary,
              should_run_extra_analytics,
              should_generate_research_concepts,
              should_run_learning_cycle,
              record_aggressive_action,
              set_aggressive_mode
          )
          
          # Enable and show status
          set_aggressive_mode(True)
          print(get_aggressive_mode_summary())
          
          # Run extra analytics if allowed
          if should_run_extra_analytics():
              print('[AGGRESSIVE] Running extra analytics...')
              record_aggressive_action('analytics', quota_used=10)
              print('[OK] Extra analytics recorded')
          else:
              print('[INFO] Extra analytics limit reached for today')
          
          # Research concepts
          if should_generate_research_concepts():
              print('[AGGRESSIVE] Research concept quota available')
              record_aggressive_action('research', quota_used=5)
              print('[OK] Research concepts recorded')
          else:
              print('[INFO] Research concept limit reached for today')
          
          # Learning cycle
          if should_run_learning_cycle():
              print('[AGGRESSIVE] Running extra learning cycle...')
              record_aggressive_action('learning', quota_used=5)
              print('[OK] Learning cycle recorded')
          else:
              print('[INFO] Learning cycle limit reached for today')
          
          print()
          print('=== FINAL STATUS ===')
          print(get_aggressive_mode_summary())
          "
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸš€ Aggressive Mode Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          python -c "
          import sys
          sys.path.insert(0, '.')
          import os
          os.environ['AGGRESSIVE_MODE'] = '1'
          
          from src.core.aggressive_mode import get_aggressive_mode_stats
          
          stats = get_aggressive_mode_stats()
          
          print(f\"### Status: {'âœ… ENABLED' if stats['enabled'] else 'âŒ DISABLED'}\")
          print()
          print('### Quota Usage')
          print(f\"- Surplus Available: ~{stats['surplus_quota']} calls/day\")
          print(f\"- Production Reserved: ~{stats['production_reserved']} calls/day\")
          print()
          print('### Actions This Run')
          s = stats['stats']
          print(f\"- Extra Analytics: {s.get('extra_analytics_runs', 0)}/10\")
          print(f\"- Research Concepts: {s.get('research_concepts_generated', 0)}/20\")
          print(f\"- Learning Cycles: {s.get('learning_cycles_completed', 0)}/5\")
          print(f\"- Total Quota Used: {s.get('quota_used', 0)}\")
          " >> $GITHUB_STEP_SUMMARY
      
      - name: Save Persistent State
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: persistent-state
          path: data/persistent/
          retention-days: 90
          if-no-files-found: ignore

name: Aggressive Mode - Extra Analytics

# Use surplus quota for extra analytics, learning, and research
# This workflow runs when aggressive mode is enabled
#
# QUOTA USAGE:
# - Uses ONLY surplus quota (quota that would expire unused)
# - Production quota is ALWAYS reserved first
# - Runs extra virality analysis
# - Generates research concepts
# - Runs additional learning cycles

on:
  # Can run daily or more frequently
  schedule:
    - cron: '30 */6 * * *'  # Every 6 hours
  
  workflow_dispatch:
    inputs:
      actions:
        description: 'Actions to run (analytics,research,learning or all)'
        required: false
        default: 'all'
        type: string

permissions:
  contents: write
  actions: read

jobs:
  aggressive-mode:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Restore Persistent State
        run: |
          mkdir -p data/persistent
          
          ARTIFACT_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/artifacts?name=persistent-state&per_page=1" \
            | jq -r '.artifacts[0].id')
          
          if [ "$ARTIFACT_ID" != "null" ] && [ -n "$ARTIFACT_ID" ]; then
            curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
              -o /tmp/state.zip
            unzip -o /tmp/state.zip -d data/persistent/ 2>/dev/null || true
            echo "[OK] Restored persistent state"
          fi
      
      - name: Check Aggressive Mode Status
        id: check_mode
        env:
          AGGRESSIVE_MODE: "1"
        run: |
          python -c "
          from src.core.aggressive_mode import is_aggressive_mode_enabled, get_aggressive_mode_summary
          print(get_aggressive_mode_summary())
          
          # Check if enabled
          if is_aggressive_mode_enabled():
              print('::set-output name=enabled::true')
          else:
              print('::set-output name=enabled::false')
          "
      
      - name: Run Extra Analytics
        if: steps.check_mode.outputs.enabled == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          AGGRESSIVE_MODE: "1"
        run: |
          echo "=============================================="
          echo "  AGGRESSIVE MODE: EXTRA ANALYTICS"
          echo "=============================================="
          
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          from src.core.aggressive_mode import (
              should_run_extra_analytics,
              record_aggressive_action,
              get_aggressive_mode_summary
          )
          
          if should_run_extra_analytics():
              print('[AGGRESSIVE] Running extra analytics...')
              # Import and run analytics
              try:
                  from scripts.analyze_workflows import main as analyze_main
                  analyze_main(days=1)
                  record_aggressive_action('analytics', quota_used=10)
                  print('[OK] Extra analytics completed')
              except Exception as e:
                  print(f'[WARN] Analytics failed: {e}')
          else:
              print('[INFO] Extra analytics limit reached for today')
          
          print(get_aggressive_mode_summary())
          "
      
      - name: Run Research Concept Generation
        if: steps.check_mode.outputs.enabled == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          AGGRESSIVE_MODE: "1"
        run: |
          echo "=============================================="
          echo "  AGGRESSIVE MODE: RESEARCH CONCEPTS"
          echo "=============================================="
          
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          from src.core.aggressive_mode import (
              should_generate_research_concepts,
              record_aggressive_action
          )
          
          if should_generate_research_concepts():
              print('[AGGRESSIVE] Generating research concepts...')
              # Generate and evaluate concepts without uploading
              try:
                  # Use pre-work fetcher in research mode
                  from scripts.pre_work_fetcher import generate_concepts
                  concepts = generate_concepts(count=5, research_mode=True)
                  if concepts:
                      record_aggressive_action('research', quota_used=len(concepts) * 3)
                      print(f'[OK] Generated {len(concepts)} research concepts')
              except Exception as e:
                  print(f'[INFO] Research generation skipped: {e}')
          else:
              print('[INFO] Research concept limit reached for today')
          "
      
      - name: Run Extra Learning Cycle
        if: steps.check_mode.outputs.enabled == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          AGGRESSIVE_MODE: "1"
        run: |
          echo "=============================================="
          echo "  AGGRESSIVE MODE: EXTRA LEARNING CYCLE"
          echo "=============================================="
          
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          from src.core.aggressive_mode import (
              should_run_learning_cycle,
              record_aggressive_action,
              get_aggressive_mode_summary
          )
          
          if should_run_learning_cycle():
              print('[AGGRESSIVE] Running extra learning cycle...')
              try:
                  # Trigger self-learning update
                  from src.core.self_learning_manager import update_patterns
                  update_patterns()
                  record_aggressive_action('learning', quota_used=5)
                  print('[OK] Extra learning cycle completed')
              except Exception as e:
                  print(f'[INFO] Learning cycle skipped: {e}')
          else:
              print('[INFO] Learning cycle limit reached for today')
          
          print()
          print(get_aggressive_mode_summary())
          "
      
      - name: Save Persistent State
        if: always()
        run: |
          # Only save aggressive mode state, not production state
          echo "[INFO] Aggressive mode stats saved in persistent state"
      
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸš€ Aggressive Mode Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          python -c "
          import sys
          sys.path.insert(0, '.')
          from src.core.aggressive_mode import get_aggressive_mode_stats
          import os
          
          # Enable aggressive mode for this run
          os.environ['AGGRESSIVE_MODE'] = '1'
          
          stats = get_aggressive_mode_stats()
          
          print(f\"### Status: {'âœ… ENABLED' if stats['enabled'] else 'âŒ DISABLED'}\")
          print()
          print('### Quota Usage')
          print(f\"- Surplus Available: ~{stats['surplus_quota']} calls/day\")
          print(f\"- Production Reserved: ~{stats['production_reserved']} calls/day\")
          print()
          print('### Actions This Run')
          s = stats['stats']
          print(f\"- Extra Analytics: {s.get('extra_analytics_runs', 0)}/10\")
          print(f\"- Research Concepts: {s.get('research_concepts_generated', 0)}/20\")
          print(f\"- Learning Cycles: {s.get('learning_cycles_completed', 0)}/5\")
          print(f\"- Total Quota Used: {s.get('quota_used', 0)}\")
          " >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Updated State
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: persistent-state
          path: data/persistent/
          retention-days: 90
          if-no-files-found: ignore
